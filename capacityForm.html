<!DOCTYPE html>
<html>
<head>
  <title>Kapasite Verisi</title>
  <style>
    /* Add this style for the table header cells */
  table th {
    position: sticky;
    top: 0;
    background-color: #f1f1f1; /* Customize the background color as needed */

  }

  /* Add this style for the row header cells */
  table th:first-child {
    position: sticky;
    left: 0;
    background-color: #f1f1f1; /* Customize the background color as needed */

  }
        



    #date-form {
          display: flex;
          flex-direction: row;
          justify-content: center;
          align-items: center;
          margin-bottom: 10px;
          padding: 10px;
          border: 1px solid gray;
          border-radius: 5px;
          max-width: 300px;
          font-family: Arial, sans-serif;
}
        }
        
        #date-form label {
          margin-right: 10px;
        }
        
        #date-form input[type="date"] {
          border: 1px solid gray;
          border-radius: 5px;
          padding: 5px;
          font-size: 20px;
          font-family: Arial, sans-serif;
        }
    .container {
      margin: 20px;
    }

     table {
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 5px;
        }


     /* Submit button styles */
        .submit-btn {
          display: inline-block;
          padding: 10px 20px;
          background-color: #2c3e50;
          color: white;
          font-size: 16px;
          border-radius: 5px;
          cursor: pointer;
          transition: all 0.3s ease;
        }
        
        .submit-btn:hover {
          background-color: #34495e;
        }
        
        .submit-btn:active {
          transform: translateY(1px);
        }   
  </style>
  
</head>
<body>


  <div class="container" id="date-form" style="display: none;">
    <label for="date">Tarih Seçin:</label>
    <input type="date" id="date" name="date" onchange="logTimestamp()">
  </div>
  
  <table id="capacityForm"></table>


  <button  id="submitButton" style="display: none;" class="submit-btn"  onclick="readSaveValues()">Kaydet</button>
  <br>
  <br>
 


<!-- AWS Javascript SDKs-->
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.988.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js/dist/amazon-cognito-identity.min.js"></script>
<script>

  var company = "";
  var site    = "";
  let timestamp=0;
  var titles; 
  var val; 

  let headers =[];
  let sub_headers =[];
  let row_headers =[];
  var meta_data;
  var columnHeaders; 
  var rowHeaders1; 
  var rowHeaders2; 
  var raw_data={};

  // Check the user info on AWS and get the details of user
  var data = {
    UserPoolId  : 'us-east-1_1uKtiajQH',
    ClientId    : '4rigc1mv6tt9h9kn5dvf8p859f'
  };

  var userPool    = new AmazonCognitoIdentity.CognitoUserPool(data);
  var cognitoUser = userPool.getCurrentUser();

  cognitoUser.getSession(function(err, session) {
          if (err) {
            alert(err);
            return;
          }


          // Add the User's Id Token to the Cognito credentials login map.
          AWS.config.region   = 'us-east-1';
          AWS.config.credentials  = new AWS.CognitoIdentityCredentials({
              IdentityPoolId: 'us-east-1:66ff584c-19c8-4e26-bd4a-ddb513efa027',   
              Logins: {
                'cognito-idp:us-east-1:793924894519:userpool/us-east-1_1uKtiajQH': session.getIdToken().getJwtToken()    
              }
          });

          cognitoUser.getUserAttributes(function(err, result) {
              if (err) {

                console.log(err);
                window.location.href = "login.html";
                return;
              }else{
              company = result[3].getValue();
              site    = result[2].getValue();
              
              console.log(result);
              console.log(company);
              console.log(site);


              
              
              getMetaData()
              }
             
          });

  });



function getMetaData() {
    const apiEndpoint = 'https://sxl4s33mtd.execute-api.us-east-1.amazonaws.com/get_meta/get_metadata';
    const url = `${apiEndpoint}?site=${site}`;
    fetch(url)
      .then(response => response.json())
      .then(data => {
        meta_data = data[0];
        columnHeaders =Object.values(meta_data["NAKLİYE"])
        rowHeaders1 =Object.values(meta_data["kapasite"])
        rowHeaders2 =Object.values(meta_data["metrik"])
        
        console.log("columnHeaders:    ",columnHeaders)
        console.log("rowHeaders1:    ",rowHeaders1)
        console.log("rowHeaders2:    ",rowHeaders2)
        //createTable()
        document.getElementById('date-form').style.display = 'block';

      })
      .catch(error => console.error(error));
  }











    function logTimestamp() {
      


      
      var dateInput = document.getElementById('date');
      


      let dateString = dateInput.value;
      const [year, month, day] = dateString.split('-').map(Number);
      const chosenUTC = Date.UTC(year, month - 1, day, 0, 0, 0);
      timestamp = chosenUTC/1000
      
      //timestamp = new Date(selectedDate).getTime();
      //timestamp = timestamp /1000
      //timestamp = timestamp -10800;
     
      //timestamp = 1682802000
      console.log(timestamp);
      getCapacity()
      
      
    }






    function getCapacity() {
      const apiEndpoint = 'https://ao672tw5b6.execute-api.us-east-1.amazonaws.com/daily/get_capacity';
      const url = `${apiEndpoint}?site=${site}&company=${company}&ts=${timestamp}`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          
          raw_data = data
          //titles = Object.keys(data);
          //val = Object.values(data);

          
          console.log(raw_data);
          //console.log(val);
          //createTableForm()
          createTable()
          

        })
         
        .catch(error => console.error(error));

        
    }


    function createTable() {
        // Sample data for column and row headers
      try { 
        capacityForm.innerHTML = ''; // Clear existing form content
      }
      catch{
        console.log("first")
      }
        
        // Create the table
        const table = document.getElementById("capacityForm");

        var thead = document.createElement("thead");
        var tbody = document.createElement("tbody");

        // Create the table header row
        const headerRow = document.createElement('tr');
        const emptyHeaderCell = document.createElement('th');
        headerRow.appendChild(emptyHeaderCell); // An empty header cell in the top-left corner
        const emptyHeaderCell2 = document.createElement('th');
        headerRow.appendChild(emptyHeaderCell2); // An empty header cell in the top-left corner
        for (const columnHeader of columnHeaders) { // Use 'of' instead of 'in' to iterate over array elements
            const headerCell = document.createElement('th');
            headerCell.textContent = columnHeader; // Fix the assignment of column header text
            headerCell.style.width = '100px';
            headerRow.appendChild(headerCell);
        }
        thead.appendChild(headerRow);

        // Create rows and input cells
        for (const rowHeader1 of rowHeaders1) { // Use 'of' instead of 'in' to iterate over array elements
            

            for (const rowHeader2 of rowHeaders2) { // Use 'of' instead of 'in' to iterate over array elements
                const row = document.createElement('tr');
                const rowHeaderCell1 = document.createElement('th');
                rowHeaderCell1.textContent = rowHeader1;
                rowHeaderCell1.style.textAlign = 'left';
                row.appendChild(rowHeaderCell1);
                const rowHeaderCell2 = document.createElement('th');
                rowHeaderCell2.textContent = rowHeader2;
                rowHeaderCell2.style.textAlign = 'left';
                row.appendChild(rowHeaderCell2);


                for (let i = 0; i < columnHeaders.length; i++){
                    const cell = document.createElement('td');
                    const input = document.createElement('input');
                    input.type = 'number';
                    try{
                      input.value =  parseFloat(raw_data[columnHeaders[i]][rowHeader1][rowHeader2]) ;
                    }catch{
                      input.value =  0 ;
                    }
                    
                    //console.log(raw_data[columnHeaders[i]][rowHeader1][rowHeader2])
                    cell.appendChild(input); // Append the input field to the cell
                    row.appendChild(cell);
                    tbody.appendChild(row);
                }
            }
            
        }

        table.appendChild(thead);
        table.appendChild(tbody);
        document.body.appendChild(table);
        table.appendChild(document.createElement("br"));
        document.getElementById('submitButton').style.display = 'block';
    }

/*
    function createTableForm(){

        const form = document.getElementById("capacityForm");
        form.innerHTML = ''; // Clear existing form content
        for (let i = 0; i < titles.length; i++) {
            const row = document.createElement("tr");

            const header = document.createElement("th");
            header.textContent = titles[i];
            row.appendChild(header);

            const valueInput = document.createElement("td");
            const value = document.createElement("input");
            value.type = "number";
            value.name = "row" + (i + 1);
            value.value = val[i] ; //|| "" Assign value from API response or empty string if no value available
            valueInput.appendChild(value);
            row.appendChild(valueInput);

            form.appendChild(row);
          }
          form.appendChild(document.createElement("br"));
          document.getElementById('submitButton').style.display = 'block';

          //createTable()
    }     

*/


     function readSaveValues() {

        const form = document.getElementById("capacityForm"); // Get the form element
        const inputElements = form.getElementsByTagName("input"); // Get all input elements within the form
        

        //columnHeaders
        //rowHeaders1
        //rowHeaders2

         
        var cnt = 0
        const capacityForm ={}


       

        var leng = columnHeaders.length
        var part = inputElements.length / leng
        for (let i = 0; i < columnHeaders.length; i++) {
              
              const kapasite ={}
              for (let j = 0; j < rowHeaders1.length; j++) {

                    const metrik ={}
                    for (let k = 0; k < rowHeaders2.length; k++) {
                        var artik = cnt%part
                        var rd = Math.floor( cnt / part) 
                        var cnt2 = (artik*leng)+rd
                        const input = inputElements[cnt2];
                        
                        metrik[rowHeaders2[k]] = input.value
                        cnt = cnt + 1

                    }
                    kapasite[rowHeaders1[j]]= metrik
                 
          
              }  
              capacityForm[columnHeaders[i]] = kapasite
              
              
        }


         console.log(capacityForm);
          
         
          


          
          const apiEndpoint = 'https://0kpcnjasg0.execute-api.us-east-1.amazonaws.com/update/capacity';
          const datasetParam = encodeURIComponent(JSON.stringify(capacityForm));
          const url = `${apiEndpoint}?ts=${timestamp}&dataset=${datasetParam}&company=${company}&site=${site}`;


          var xhttp = new XMLHttpRequest();
          
          const confirmed = confirm(`Emin misiniz?`);
                    if (confirmed) { // only proceed if user confirmed
                            xhttp.open("GET",url, true);
                            xhttp.send();
                            xhttp.onreadystatechange = function() {
                            if (this.readyState === 4) {
                              if (this.status === 200) {
                                // Request completed successfully
                                alert("Veriler Gönderildi");
                              } else {
                                // An error occurred
                                alert("Hata Oluştu");
                              }
                            }
                          };
                            //document.body.innerHTML = '';
                            //window.location.href = "mainpage.html";
                        }
     
    }



  </script>  
</body>
</html>
